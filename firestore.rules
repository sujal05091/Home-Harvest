rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // ===================
    // RIDER LOCATIONS (Real-time GPS tracking)
    // ===================
    match /rider_locations/{riderId} {
      // Anyone authenticated can read (for live tracking)
      allow read: if isAuthenticated();
      
      // Only the rider can write their own location
      allow write: if isUser(riderId);
    }
    
    // Alternative collection name (riderLocations without underscore)
    match /riderLocations/{riderId} {
      // Anyone authenticated can read (for live tracking)
      allow read: if isAuthenticated();
      
      // Only the rider can write their own location
      allow write: if isUser(riderId);
    }
    
    // ===================
    // ORDERS
    // ===================
    match /orders/{orderId} {
      // Read: Customer, Cook, or assigned Rider
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.cookId == request.auth.uid ||
        resource.data.assignedRiderId == request.auth.uid
      );
      
      // Create: Only authenticated users (customer creating order)
      allow create: if isAuthenticated() && 
        request.resource.data.customerId == request.auth.uid;
      
      // Update: Customer (cancel), Cook (accept), Rider (status updates), System (FCM)
      allow update: if isAuthenticated() && (
        // Customer can cancel their own order
        (resource.data.customerId == request.auth.uid && 
         request.resource.data.status == 'CANCELLED') ||
        
        // Cook can accept their order
        (resource.data.cookId == request.auth.uid && 
         request.resource.data.status in ['ACCEPTED', 'CANCELLED']) ||
        
        // Rider can update status when assigned
        (resource.data.assignedRiderId == request.auth.uid &&
         request.resource.data.status in [
           'RIDER_ACCEPTED',
           'ON_THE_WAY_TO_PICKUP',
           'PICKED_UP',
           'ON_THE_WAY_TO_DROP',
           'DELIVERED'
         ]) ||
         
        // ANY rider can update during assignment phase (before RIDER_ACCEPTED)
        // This allows riders to accept orders and add themselves to rejectedBy array
        (request.resource.data.status in ['PLACED', 'ACCEPTED', 'RIDER_ASSIGNED', 'RIDER_ACCEPTED'] &&
         request.resource.data.keys().hasAny(['assignedRiderId', 'assignedRiderName', 'rejectedBy', 'notifiedRiders']))
      );
      
      // Delete: Not allowed
      allow delete: if false;
    }
    
    // ===================
    // USERS (FCM tokens and online status)
    // ===================
    match /users/{userId} {
      // Read: Anyone authenticated (for displaying names, finding riders, etc.)
      allow read: if isAuthenticated();
      
      // Write: Only the user themselves
      // Allow partial updates for FCM token, isOnline, currentLocation
      allow write: if isUser(userId);
      
      // Allow FCM token updates without full authentication (for background updates)
      allow update: if isUser(userId) || (
        isAuthenticated() &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['fcmToken', 'isOnline', 'currentLocation'])
      );
    }
    
    // ===================
    // DISHES
    // ===================
    match /dishes/{dishId} {
      // Read: Anyone authenticated
      allow read: if isAuthenticated();
      
      // Write: Only the cook who owns the dish
      allow create: if isAuthenticated() && 
        request.resource.data.cookId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
        resource.data.cookId == request.auth.uid;
    }
    
    // ===================
    // REVIEWS
    // ===================
    match /reviews/{reviewId} {
      // Read: Anyone authenticated
      allow read: if isAuthenticated();
      
      // Write: Only the customer who wrote the review
      allow create: if isAuthenticated() && 
        request.resource.data.customerId == request.auth.uid;
      
      allow update, delete: if isAuthenticated() && 
        resource.data.customerId == request.auth.uid;
    }
    
    // ===================
    // CHATS
    // ===================
    match /chats/{chatId} {
      // Read: Only participants
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.participantIds
      );
      
      // Create: Authenticated users
      allow create: if isAuthenticated() && (
        request.auth.uid in request.resource.data.participantIds
      );
      
      // Update: Participants only
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.participantIds
      );
      
      // Messages subcollection
      match /messages/{messageId} {
        // Read: Anyone who can read the chat
        allow read: if isAuthenticated();
        
        // Create: Only participants can send messages
        allow create: if isAuthenticated() && (
          request.resource.data.senderId == request.auth.uid
        );
      }
    }
    
    // ===================
    // ADDRESSES
    // ===================
    match /addresses/{addressId} {
      // Read/Write: Only the owner
      allow read, write: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
        
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
    }
    
    // ===================
    // DELIVERIES (if you have a separate collection)
    // ===================
    match /deliveries/{deliveryId} {
      // Read: Customer, Cook, or Rider
      allow read: if isAuthenticated();
      
      // Write: Rider only
      allow write: if isAuthenticated();
    }
    
    // ===================
    // NOTIFICATIONS (Real-time delivery notifications)
    // ===================
    match /notifications/{notificationId} {
      // Read: Only the recipient can read their notifications
      allow read: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid;
      
      // Create: Any authenticated user can create notifications
      allow create: if isAuthenticated();
      
      // Update: Only the recipient can mark as read
      allow update: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid;
      
      // Delete: Only the recipient can delete
      allow delete: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid;
    }
    
    // ===================
    // DEFAULT: Deny all
    // ===================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
