rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ” HELPER FUNCTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isUser(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }
    
    function isCook() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'cook';
    }
    
    function isRider() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'rider';
    }
    
    function isCustomer() {
      return isAuthenticated() && 
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'customer';
    }
    
    // Valid order status transitions
    function isValidStatusTransition(oldStatus, newStatus) {
      return (oldStatus == 'PLACED' && newStatus in ['ACCEPTED', 'CANCELLED']) ||
             (oldStatus == 'ACCEPTED' && newStatus in ['RIDER_ASSIGNED', 'CANCELLED']) ||
             (oldStatus == 'RIDER_ASSIGNED' && newStatus in ['RIDER_ACCEPTED', 'PLACED', 'CANCELLED']) ||
             (oldStatus == 'RIDER_ACCEPTED' && newStatus in ['ON_THE_WAY_TO_PICKUP', 'CANCELLED']) ||
             (oldStatus == 'ON_THE_WAY_TO_PICKUP' && newStatus == 'PICKED_UP') ||
             (oldStatus == 'PICKED_UP' && newStatus == 'ON_THE_WAY_TO_DROP') ||
             (oldStatus == 'ON_THE_WAY_TO_DROP' && newStatus == 'DELIVERED') ||
             (oldStatus == 'CANCELLED' && newStatus == 'CANCELLED') ||
             (oldStatus == 'DELIVERED' && newStatus == 'DELIVERED');
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸš€ RIDER LOCATIONS (Real-time GPS tracking)
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /rider_locations/{riderId} {
      // Anyone authenticated can read (for live tracking)
      allow read: if isAuthenticated();
      
      // Only the rider themselves OR admin can write their location
      allow write: if isUser(riderId) || isAdmin();
    }
    
    match /riderLocations/{riderId} {
      allow read: if isAuthenticated();
      allow write: if isUser(riderId) || isAdmin();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ“¦ ORDERS - Role-Based Access with State Validation
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /orders/{orderId} {
      // Read: Customer, Cook, Assigned Rider, or Admin
      allow read: if isAuthenticated() && (
        resource.data.customerId == request.auth.uid ||
        resource.data.cookId == request.auth.uid ||
        resource.data.assignedRiderId == request.auth.uid ||
        isAdmin()
      );
      
      // Create: Only customers can create orders
      allow create: if isAuthenticated() && 
        isCustomer() &&
        request.resource.data.customerId == request.auth.uid &&
        request.resource.data.status == 'PLACED';
      
      // Update with strict role-based permissions and status validation
      allow update: if isAuthenticated() && (
        // ADMIN: Full access
        isAdmin() ||
        
        // CUSTOMER: Can only cancel their own orders
        (resource.data.customerId == request.auth.uid && 
         isCustomer() &&
         request.resource.data.status == 'CANCELLED' &&
         isValidStatusTransition(resource.data.status, 'CANCELLED')) ||
        
        // COOK: Can accept/reject orders assigned to them
        (resource.data.cookId == request.auth.uid && 
         isCook() &&
         request.resource.data.status in ['ACCEPTED', 'RIDER_ASSIGNED', 'CANCELLED'] &&
         isValidStatusTransition(resource.data.status, request.resource.data.status)) ||
        
        // RIDER (ASSIGNED): Can update status after being assigned
        (resource.data.assignedRiderId == request.auth.uid &&
         isRider() &&
         request.resource.data.status in [
           'RIDER_ACCEPTED',
           'ON_THE_WAY_TO_PICKUP',
           'PICKED_UP',
           'ON_THE_WAY_TO_DROP',
           'DELIVERED'
         ] &&
         isValidStatusTransition(resource.data.status, request.resource.data.status)) ||
         
        // RIDER (UNASSIGNED): Can accept orders or reject them
        (isRider() &&
         request.resource.data.status in ['RIDER_ACCEPTED', 'RIDER_ASSIGNED'] &&
         request.resource.data.keys().hasAny(['assignedRiderId', 'assignedRiderName', 'rejectedBy', 'notifiedRiders']) &&
         isValidStatusTransition(resource.data.status, request.resource.data.status))
      );
      
      // Delete: Only admins
      allow delete: if isAdmin();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ‘¥ USERS - Profile Management with Role Protection
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /users/{userId} {
      // Read: Anyone authenticated (for names, finding riders, etc.)
      allow read: if isAuthenticated();
      
      // Create: During signup
      allow create: if isAuthenticated() && 
        request.auth.uid == userId;
      
      // Update: User can update their own profile
      // CRITICAL: Users CANNOT change their own role (only admin can)
      allow update: if isAuthenticated() && (
        // User updates own profile (except role)
        (isUser(userId) && 
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isVerified'])) ||
        
        // Admin can update anyone's profile including role and verification
        isAdmin()
      );
      
      // Delete: Only admin
      allow delete: if isAdmin();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ½ï¸ DISHES - Cook-Only Management
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /dishes/{dishId} {
      // Read: Anyone authenticated
      allow read: if isAuthenticated();
      
      // Create: Only verified cooks
      allow create: if isAuthenticated() && 
        isCook() &&
        request.resource.data.cookId == request.auth.uid &&
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isVerified == true;
      
      // Update/Delete: Only the cook who owns the dish OR admin
      allow update, delete: if isAuthenticated() && (
        (resource.data.cookId == request.auth.uid && isCook()) ||
        isAdmin()
      );
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ“ REVIEWS - Customer-Only Creation
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /reviews/{reviewId} {
      // Read: Anyone authenticated
      allow read: if isAuthenticated();
      
      // Create: Only customers who placed the order
      allow create: if isAuthenticated() && 
        isCustomer() &&
        request.resource.data.customerId == request.auth.uid;
      
      // Update/Delete: Only the review author OR admin
      allow update, delete: if isAuthenticated() && (
        (resource.data.customerId == request.auth.uid && isCustomer()) ||
        isAdmin()
      );
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ“§ VERIFICATION REQUESTS - Cook Verification System
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /verifications/{verificationId} {
      // Read: The cook who submitted OR admin
      allow read: if isAuthenticated() && (
        resource.data.cookId == request.auth.uid ||
        isAdmin()
      );
      
      // Create: Only cooks can submit verification
      allow create: if isAuthenticated() && 
        isCook() &&
        request.resource.data.cookId == request.auth.uid;
      
      // Update: Only admin can approve/reject
      allow update: if isAdmin();
      
      // Delete: Only admin
      allow delete: if isAdmin();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ’¬ CHATS - Participant-Only Access
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /chats/{chatId} {
      // Read: Only participants
      allow read: if isAuthenticated() && (
        request.auth.uid in resource.data.participantIds
      );
      
      // Create: Authenticated users
      allow create: if isAuthenticated() && (
        request.auth.uid in request.resource.data.participantIds
      );
      
      // Update: Participants only
      allow update: if isAuthenticated() && (
        request.auth.uid in resource.data.participantIds
      );
      
      // Messages subcollection
      match /messages/{messageId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated() && (
          request.resource.data.senderId == request.auth.uid
        );
      }
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ“ ADDRESSES - User-Only Access
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /addresses/{addressId} {
      allow read: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
        
      allow create: if isAuthenticated() && 
        request.resource.data.userId == request.auth.uid;
        
      allow update, delete: if isAuthenticated() && 
        resource.data.userId == request.auth.uid;
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸšš DELIVERIES - Real-time Tracking Data
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /deliveries/{deliveryId} {
      // Read: Customer, Cook, Rider, or Admin
      allow read: if isAuthenticated();
      
      // Write: Only assigned rider OR admin can update delivery data
      allow create, update: if isAuthenticated() && (
        isRider() ||
        isAdmin()
      );
      
      // Delete: Only admin
      allow delete: if isAdmin();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ”” NOTIFICATIONS - Recipient-Only Access
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /notifications/{notificationId} {
      allow read: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid;
      
      allow create: if isAuthenticated();
      
      allow update: if isAuthenticated() && 
        resource.data.recipientId == request.auth.uid;
      
      allow delete: if isAuthenticated() && (
        resource.data.recipientId == request.auth.uid ||
        isAdmin()
      );
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ”§ ADMIN-ONLY COLLECTIONS
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /analytics/{document=**} {
      allow read, write: if isAdmin();
    }
    
    match /config/{document=**} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /notification_errors/{document=**} {
      allow read, write: if isAdmin();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ’° RIDER WALLETS - Rider & Admin Only
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /rider_wallets/{riderId} {
      // Read: Only the rider or admin
      allow read: if isAuthenticated() && (
        request.auth.uid == riderId ||
        isAdmin()
      );
      
      // Create: System or admin only (prevent manual wallet creation)
      allow create: if isAdmin();
      
      // Update: Only through Cloud Functions or admin
      // Riders CANNOT directly update their wallet balance
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ’³ WALLET TRANSACTIONS - Read-Only for Riders
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /wallet_transactions/{transactionId} {
      // Read: Only the rider who owns the transaction or admin
      allow read: if isAuthenticated() && (
        resource.data.riderId == request.auth.uid ||
        isAdmin()
      );
      
      // Create: System only (Cloud Functions)
      allow create: if false;
      
      // Update/Delete: Admin only
      allow update, delete: if isAdmin();
    }
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ðŸ’¸ WITHDRAWAL REQUESTS - Rider creates, Admin approves
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    match /withdrawal_requests/{requestId} {
      // Read: Only the requesting rider or admin
      allow read: if isAuthenticated() && (
        resource.data.riderId == request.auth.uid ||
        isAdmin()
      );
      
      // Create: Only riders can create withdrawal requests
      allow create: if isAuthenticated() && 
        isRider() &&
        request.resource.data.riderId == request.auth.uid &&
        request.resource.data.status == 'PENDING' &&
        request.resource.data.amount >= 100 &&  // Minimum â‚¹100
        request.resource.data.amount <= 50000;  // Maximum â‚¹50,000
      
      // Update: Only admin (for approval/rejection)
      allow update: if isAdmin();
      
      // Delete: Admin only
      allow delete: if isAdmin();
    }
    
    // ===================
    // DEFAULT: Deny all
    // ===================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
