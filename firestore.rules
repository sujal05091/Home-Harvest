rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // ğŸ” HELPER FUNCTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      function isAuthenticated() {
        return request.auth != null;
      }
      
      function isUser(userId) {
        return isAuthenticated() && request.auth.uid == userId;
      }
      
      function isAdmin() {
        return isAuthenticated() && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
      }
      
      function isCook() {
        return isAuthenticated() && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'cook';
      }
      
      function isRider() {
        return isAuthenticated() && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'rider';
      }
      
      function isCustomer() {
        return isAuthenticated() && 
              get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'customer';
      }
      
      // Valid order status transitions
      function isValidStatusTransition(oldStatus, newStatus) {
        return (oldStatus == 'PLACED' && newStatus in ['ACCEPTED', 'CANCELLED']) ||
              (oldStatus == 'ACCEPTED' && newStatus in ['PREPARING', 'RIDER_ASSIGNED', 'CANCELLED']) ||
              (oldStatus == 'PREPARING' && newStatus in ['READY', 'CANCELLED']) ||
              (oldStatus == 'READY' && newStatus in ['RIDER_ASSIGNED', 'RIDER_ACCEPTED', 'CANCELLED']) ||
              (oldStatus == 'RIDER_ASSIGNED' && newStatus in ['RIDER_ACCEPTED', 'ON_THE_WAY_TO_PICKUP', 'PLACED', 'CANCELLED']) ||
              (oldStatus == 'RIDER_ACCEPTED' && newStatus in ['ON_THE_WAY_TO_PICKUP', 'CANCELLED']) ||
              (oldStatus == 'ON_THE_WAY_TO_PICKUP' && newStatus == 'PICKED_UP') ||
              (oldStatus == 'PICKED_UP' && newStatus == 'ON_THE_WAY_TO_DROP') ||
              (oldStatus == 'ON_THE_WAY_TO_DROP' && newStatus == 'DELIVERED') ||
              (oldStatus == 'CANCELLED' && newStatus == 'CANCELLED') ||
              (oldStatus == 'DELIVERED' && newStatus == 'DELIVERED');
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ‘¥ USERS - Profile Management with Role Protection
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /users/{userId} {
        // Read: Anyone authenticated (for names, finding riders, etc.)
        allow read: if isAuthenticated();
        
        // Create: During signup
        allow create: if isAuthenticated() && 
          request.auth.uid == userId;
        
        // Update: User can update their own profile
        // CRITICAL: Users CANNOT change their own role (only admin can)
        allow update: if isAuthenticated() && (
          // User updates own profile (except role)
          (isUser(userId) && 
          !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isVerified'])) ||
          
          // Admin can update anyone's profile including role and verification
          isAdmin() ||
          
          // Allow FCM token, online status, and location updates from any authenticated user
          (isAuthenticated() &&
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['fcmToken', 'isOnline', 'currentLocation', 'fcmTokenUpdatedAt', 'lastActive'])) ||
          
          // Allow verification status updates by admin
          (isAdmin() && 
          request.resource.data.diff(resource.data).affectedKeys()
            .hasOnly(['verificationStatus', 'verified', 'verifiedAt', 'rejectionReason', 'updatedAt']))
        );
        
        // Delete: Only admin
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“¦ ORDERS - Role-Based Access with State Validation
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /orders/{orderId} {
        // Read: Customer, Cook, Assigned Rider, Any authenticated user for READY orders, or Admin
        // Removed isRider() check to avoid extra Firestore read
        allow read: if isAuthenticated() && (
          resource.data.customerId == request.auth.uid ||
          resource.data.cookId == request.auth.uid ||
          resource.data.assignedRiderId == request.auth.uid ||
          resource.data.status in ['READY', 'RIDER_ASSIGNED', 'RIDER_ACCEPTED', 'ON_THE_WAY_TO_PICKUP', 'PICKED_UP', 'ON_THE_WAY_TO_DROP'] ||
          isAdmin()
        );
        
        // Create: Only customers can create orders
        // Allow 'PLACED' for normal orders and 'READY' for tiffin/home-to-office orders
        allow create: if isAuthenticated() && 
          isCustomer() &&
          request.resource.data.customerId == request.auth.uid &&
          request.resource.data.status in ['PLACED', 'READY'];
        
        // Update with strict role-based permissions and status validation
        allow update: if isAuthenticated() && (
          // ADMIN: Full access
          isAdmin() ||
          
          // CUSTOMER: Can only cancel their own orders
          (resource.data.customerId == request.auth.uid && 
          isCustomer() &&
          request.resource.data.status == 'CANCELLED' &&
          isValidStatusTransition(resource.data.status, 'CANCELLED')) ||
          
          // COOK: Can accept/reject orders and update preparation status
          (resource.data.cookId == request.auth.uid && 
          isCook() &&
          request.resource.data.status in ['ACCEPTED', 'PREPARING', 'READY', 'RIDER_ASSIGNED', 'CANCELLED'] &&
          isValidStatusTransition(resource.data.status, request.resource.data.status)) ||
          
          // RIDER CASE A: Unassigned rider accepts READY order (READY â†’ RIDER_ASSIGNED)
          // Removed isRider() to avoid extra document read during transaction
          (resource.data.status == 'READY' &&
          ('isActive' in resource.data ? resource.data.isActive == true : true) &&
          (!('assignedRiderId' in resource.data) || resource.data.assignedRiderId == null || resource.data.assignedRiderId == '') &&
          request.resource.data.status == 'RIDER_ASSIGNED' &&
          request.resource.data.assignedRiderId == request.auth.uid &&
          isValidStatusTransition(resource.data.status, request.resource.data.status)) ||
          
          // RIDER CASE B: Assigned rider updates delivery status
          // Removed isRider() to avoid extra document read during transaction
          (resource.data.assignedRiderId == request.auth.uid &&
          request.resource.data.status in [
            'RIDER_ACCEPTED',
            'ON_THE_WAY_TO_PICKUP',
            'PICKED_UP',
            'ON_THE_WAY_TO_DROP',
            'DELIVERED'
          ] &&
          isValidStatusTransition(resource.data.status, request.resource.data.status))
        );
        
        // Delete: Only admins
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ½ï¸ DISHES - Cook-Only Management (âœ… FIXED FOR VERIFICATION)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /dishes/{dishId} {
        // Read: Anyone authenticated
        allow read: if isAuthenticated();
        
        // âœ… Create: Only verified/approved cooks can add dishes
        allow create: if isAuthenticated() && 
          isCook() &&
          request.resource.data.cookId == request.auth.uid &&
          (
            // Check new verification system (verificationStatus == 'APPROVED')
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verificationStatus == 'APPROVED' ||
            // OR check legacy verification system (verified == true) for backward compatibility
            get(/databases/$(database)/documents/users/$(request.auth.uid)).data.verified == true
          );
        
        // Update: Cook who owns the dish OR admin can update anything
        // OR any authenticated user can update rating fields (for review system)
        allow update: if isAuthenticated();
        
        // Delete: Only the cook who owns the dish OR admin
        allow delete: if isAuthenticated() && (
          (resource.data.cookId == request.auth.uid && isCook()) ||
          isAdmin()
        );
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ”” NOTIFICATIONS - Flexible Access for Push Notifications
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /notifications/{notificationId} {
        // Any authenticated user can read notifications (for debugging and rider notifications)
        allow read: if isAuthenticated();
        
        // Any authenticated user can create notifications (customer/system creating notification for rider)
        allow create: if isAuthenticated();
        
        // Any authenticated user can update notifications (rider marking as read, system updates)
        allow update: if isAuthenticated();
        
        // Any authenticated user can delete notifications or admin
        allow delete: if isAuthenticated();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“§ VERIFICATION REQUESTS - Cook Verification System (âœ… FIXED)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /cook_verifications/{verificationId} {
        // Read: The cook who submitted OR admin
        allow read: if isAuthenticated() && (
          resource.data.cookId == request.auth.uid ||
          isAdmin()
        );
        
        // Create: Only cooks can submit verification
        allow create: if isAuthenticated() && 
          isCook() &&
          request.resource.data.cookId == request.auth.uid &&
          request.resource.data.status == 'PENDING';
        
        // Update: Only admin can approve/reject
        allow update: if isAdmin();
        
        // Delete: Only admin
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’° COOK WALLETS - Real Money Management
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /cook_wallets/{cookId} {
        // Read: Only the cook can read their own wallet
        allow read: if isAuthenticated() && request.auth.uid == cookId;
        
        // Write: Only system (via Cloud Functions) or admin
        allow write: if isAdmin();
      }
      
      // Cook Wallet Transactions
      match /cook_wallet_transactions/{transactionId} {
        // Read: Only the owner cook can read their transactions
        allow read: if isAuthenticated() && 
          resource.data.cookId == request.auth.uid;
        
        // Write: Only system or admin
        allow write: if isAdmin();
      }
      
      // Cook Withdrawal Requests
      match /cook_withdrawal_requests/{withdrawalId} {
        // Read: The requesting cook or admin
        allow read: if isAuthenticated() && (
          resource.data.cookId == request.auth.uid ||
          isAdmin()
        );
        
        // Create: Only cooks can create withdrawal requests
        allow create: if isAuthenticated() && 
          isCook() &&
          request.resource.data.cookId == request.auth.uid &&
          request.resource.data.status == 'PENDING';
        
        // Update: Only admin can approve/reject/pay
        allow update: if isAdmin();
        
        // Delete: Only admin
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’³ SUBSCRIPTIONS - Admin Panel Feature
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /subscriptions/{subscriptionId} {
        allow read: if isAuthenticated() && (
          resource.data.customerId == request.auth.uid ||
          resource.data.cookId == request.auth.uid ||
          isAdmin()
        );
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && (
          resource.data.customerId == request.auth.uid ||
          isAdmin()
        );
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’¬ SUPPORT TICKETS - Admin Panel Feature
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /support_tickets/{ticketId} {
        allow read: if isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          isAdmin()
        );
        allow create: if isAuthenticated();
        allow update: if isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          isAdmin()
        );
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // âš™ï¸ PLATFORM SETTINGS - Admin Panel Configuration
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /platform_settings/{document=**} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’° WALLET TRANSACTIONS - Admin Panel Feature
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /wallet_transactions/{transactionId} {
        // Rider can read their own transactions, Admin can read all
        allow read: if isAuthenticated() && (
          resource.data.userId == request.auth.uid ||
          resource.data.riderId == request.auth.uid ||
          isAdmin()
        );
        
        // System/Admin can create transactions (during credit/debit)
        allow create: if isAuthenticated();
        
        // Only admin can update/delete
        allow update, delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’¸ WITHDRAWAL REQUESTS - Admin Panel Feature
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /withdrawal_requests/{requestId} {
        // Rider can read their own requests, Admin can read all
        allow read: if isAuthenticated() && (
          resource.data.riderId == request.auth.uid ||
          resource.data.userId == request.auth.uid ||
          isAdmin()
        );
        
        // Rider can create withdrawal requests
        allow create: if isAuthenticated() && (
          request.resource.data.riderId == request.auth.uid ||
          request.resource.data.userId == request.auth.uid
        );
        
        // Rider can update their own pending requests, Admin can approve/reject any
        allow update: if isAuthenticated() && (
          resource.data.riderId == request.auth.uid ||
          resource.data.userId == request.auth.uid ||
          isAdmin()
        );
        
        // Only admin can delete
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸš€ RIDER LOCATIONS (Real-time GPS tracking)
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /rider_locations/{riderId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      match /riderLocations/{riderId} {
        allow read: if isAuthenticated();
        allow write: if isAuthenticated();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“ ADDRESSES - User-Only Access
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /addresses/{addressId} {
        allow read: if isAuthenticated() && 
          resource.data.userId == request.auth.uid;
          
        allow create: if isAuthenticated() && 
          request.resource.data.userId == request.auth.uid;
          
        allow update, delete: if isAuthenticated() && 
          resource.data.userId == request.auth.uid;
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ“ REVIEWS - Customer-Only Creation
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /reviews/{reviewId} {
        allow read: if isAuthenticated();
        // Allow any authenticated user to create review (they placed order = they can review)
        allow create: if isAuthenticated() && 
          request.resource.data.customerId == request.auth.uid;
        // Allow user to update/delete their own review, or admin can manage all
        allow update, delete: if isAuthenticated() && (
          resource.data.customerId == request.auth.uid ||
          isAdmin()
        );
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’¬ CHATS - Participant-Only Access
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /chats/{chatId} {
        allow read: if isAuthenticated() && (
          request.auth.uid in resource.data.participantIds
        );
        allow create: if isAuthenticated() && (
          request.auth.uid in request.resource.data.participantIds
        );
        allow update: if isAuthenticated() && (
          request.auth.uid in resource.data.participantIds
        );
        
        match /messages/{messageId} {
          allow read: if isAuthenticated();
          allow create: if isAuthenticated() && (
            request.resource.data.senderId == request.auth.uid
          );
        }
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // â­ FAVORITES - User's Saved Dishes and Cooks
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /favorites/{userId} {
        // Users can read their own favorites
        allow read: if isAuthenticated() && (
          request.auth.uid == userId ||
          isAdmin()
        );
        
        // Users can create/update their own favorites
        allow create, update: if isAuthenticated() && request.auth.uid == userId;
        
        // Users can delete their own favorites
        allow delete: if isAuthenticated() && request.auth.uid == userId;
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸšš DELIVERIES - Real-time Tracking Data
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /deliveries/{deliveryId} {
        allow read: if isAuthenticated();
        allow create: if isAuthenticated();
        allow update: if isAuthenticated();
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’° RIDER WALLETS - Rider & Admin Only
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /rider_wallets/{riderId} {
        // Rider can read their own wallet, Admin can read all
        allow read: if isAuthenticated() && (
          request.auth.uid == riderId ||
          isAdmin()
        );
        
        // Rider can create their own wallet during initial setup
        allow create: if isAuthenticated() && request.auth.uid == riderId;
        
        // Rider can update their own wallet (for transactions), Admin can update any wallet
        allow update: if isAuthenticated() && (
          request.auth.uid == riderId ||
          isAdmin()
        );
        
        // Only admin can delete wallets
        allow delete: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ”§ ADMIN-ONLY COLLECTIONS
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /analytics/{document=**} {
        allow read, write: if isAdmin();
      }
      
      match /config/{document=**} {
        allow read: if isAuthenticated();
        allow write: if isAdmin();
      }
      
      match /notification_errors/{document=**} {
        allow read, write: if isAdmin();
      }
      
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      // ğŸ’³ TRANSACTIONS - Financial Records
      // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
      match /transactions/{transactionId} {
        allow read: if isAdmin() || 
                    resource.data.userId == request.auth.uid ||
                    resource.data.cookId == request.auth.uid ||
                    resource.data.riderId == request.auth.uid;
        allow write: if isAdmin();
      }
      
      // ===================
      // DEFAULT: Deny all
      // ===================
      match /{document=**} {
        allow read, write: if false;
      }
    }
  }
